<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Wikiprofia – Streamer Archive</title>
  <meta name="description" content="A parody encyclopedia for Soulsborne hitless & speedrunners." />

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Wikiprofia" />
  <meta property="og:title" content="Wikiprofia – Streamer Archive" />
  <meta property="og:description" content="A parody encyclopedia for Soulsborne hitless & speedrunners." />
  <meta property="og:url" content="https://proforprof.com/wikiprofia/" />
  <meta property="og:image" content="https://proforprof.com/profify/profco.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Wikiprofia – Streamer Archive" />
  <meta name="twitter:description" content="A parody encyclopedia for Soulsborne hitless & speedrunners." />
  <meta name="twitter:image" content="https://proforprof.com/profify/profco.png" />

  <!-- Data + Search -->
  <link rel="preload" href="/wikiprofia/manifest.json" as="fetch" crossorigin="anonymous" />
  <script src="/wikiprofia/search.js" defer></script>

  <!-- Styles -->
  <style>
    :root { --ink:#202122; --rule:#a2a9b1; --blue:#0645ad; --muted:#666; --twitch:#9146FF; }
    * { box-sizing: border-box; }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:#f9f9f9; color:var(--ink);
      max-width: 1000px; margin: 2rem auto; padding: 1rem; line-height:1.6;
    }
    header h1{ margin:0 0 .25rem 0 }
    header .muted{ color:var(--muted); margin-bottom:1rem }
    a{ color:var(--blue); text-decoration:none }
    a:hover{ text-decoration:underline }

    /* search */
    .search{
      position: sticky; top: 0;
      background:#f9f9f9; padding:.75rem 0;
      border-bottom:1px solid #e1e1e1; z-index: 10;
    }
    .search input{
      width: 100%; padding:.7rem 1rem;
      border:1px solid var(--rule); border-radius:10px; font-size:1rem;
    }
    .results{ margin-top:.5rem }
    .result{ padding:.6rem 0; border-bottom:1px solid #e9e9e9 }
    .result a.title{ font-weight:600 }
    .snippet{ color:#444; margin-top:.25rem }

    /* grid cards */
    .grid{
      display:grid; gap:12px; margin-top:1rem;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    .card{
      display:flex; gap:12px; align-items:flex-start;
      border:1px solid #e1e1e1; border-radius:12px; background:#fff; padding:12px;
    }
    .avatar{
      width:64px; height:64px; flex:0 0 64px;
      border-radius:9999px; object-fit:cover; border:1px solid #ddd; background:#fafafa;
    }
    .meta{ flex:1 1 auto; min-width:0 }
    .t{ display:block; font-weight:700; line-height:1.25; margin:2px 0 }
    .desc{ color:#555; font-size:.95rem }

    /* actions */
    .actions{ margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap }
    .btn{
      display:inline-block; padding:.4rem .7rem; border-radius:8px;
      border:1px solid var(--twitch); background:#fff; color:var(--twitch);
      font-weight:600; font-size:.9rem; line-height:1; text-decoration:none;
      transition:background .15s, color .15s;
    }
    .btn:hover{ background:var(--twitch); color:#fff; text-decoration:none }

    .notice{ margin-top:1rem; padding:.75rem 1rem; border:1px solid #e9e9e9; border-radius:8px; background:#fff; color:#444 }
    footer{
      font-size:.9rem; color:#555;
      margin-top:2rem; border-top:1px solid #ddd; padding-top:1rem;
    }
  </style>
</head>
<body>

<header>
  <h1>Wikiprofia</h1>
  <div class="muted">A parody encyclopedia for hitless & speedrunners.</div>
</header>

<!-- Site-wide Search -->
<div class="search">
  <input id="wikia-search-input" type="search"
         placeholder="Search runners, games, memes (e.g., ‘Soulless’, ‘Malenia’, ‘mutton chops’)…" />
  <div id="wikia-search-results" class="results" hidden></div>
</div>

<h2>Runners</h2>
<div id="runner-grid" class="grid"></div>
<div id="runner-status" class="notice" hidden></div>

<footer>
  Made with ❤️ by <a href="https://proforprof.com">ProfOrProf</a>. Not affiliated with Wikipedia or Twitch.
</footer>

<!-- Card rendering + search init -->
<script>
  const MANIFEST_URL = '/wikiprofia/manifest.json'; // <- absolute path is safest on Netlify
  const FALLBACK_AVATAR = 'https://proforprof.com/profify/profco.png';
  const avatarCache = new Map();

  function showStatus(msg) {
    const box = document.getElementById('runner-status');
    box.textContent = msg;
    box.hidden = false;
  }

  async function resolveAvatarForRunner(r) {
    try {
      if (r.avatar && r.avatar.trim()) return r.avatar.trim();

      const handle = (r.twitch && typeof r.twitch === 'string') ? r.twitch.trim().toLowerCase() : '';
      if (!handle) return FALLBACK_AVATAR;

      if (avatarCache.has(handle)) return avatarCache.get(handle);

      const resp = await fetch(`https://unavatar.io/twitch/${encodeURIComponent(handle)}?json`, { cache: 'force-cache' });
      if (!resp.ok) throw new Error('unavatar http ' + resp.status);
      const data = await resp.json();
      const url = (data && data.url) ? data.url : FALLBACK_AVATAR;
      avatarCache.set(handle, url);
      return url;
    } catch (e) {
      console.warn('Avatar resolve failed for', r.title || r.twitch, e);
      return FALLBACK_AVATAR;
    }
  }

  (async function loadAndRender() {
    try {
      const res = await fetch(MANIFEST_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Manifest fetch failed (${res.status}) from ${MANIFEST_URL}`);
      const data = await res.json();

      if (!data || !Array.isArray(data.runners)) {
        console.error('Manifest JSON shape invalid:', data);
        showStatus('No runners found. Check manifest.json format (must contain { "runners": [ ... ] }).');
        return;
      }
      if (data.runners.length === 0) {
        showStatus('No runners listed yet. Add entries to manifest.json.');
        return;
      }

      const grid = document.getElementById('runner-grid');

      // Resolve avatars in parallel
      const resolved = await Promise.all(
        data.runners.map(async r => ({ r, avatar: await resolveAvatarForRunner(r) }))
      );

      resolved.forEach(({ r, avatar }) => {
        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('img');
        img.className = 'avatar';
        img.loading = 'lazy';
        img.alt = `${r.title} avatar`;
        img.referrerPolicy = 'no-referrer';
        img.src = avatar || FALLBACK_AVATAR;
        img.onerror = () => { img.src = FALLBACK_AVATAR; };

        const meta = document.createElement('div');
        meta.className = 'meta';

        const title = `<a class="t" href="${r.url}">${r.title}</a>`;
        const desc  = `<div class="desc">${r.description ? r.description : ''}</div>`;

        let actions = '';
        const handle = (r.twitch && typeof r.twitch === 'string') ? r.twitch.trim().toLowerCase() : '';
        if (handle) {
          const twitchUrl = `https://www.twitch.tv/${handle}`;
          actions = `
            <div class="actions">
              <a class="btn" href="${twitchUrl}" target="_blank" rel="noopener noreferrer"
                 aria-label="Follow ${handle} on Twitch">
                Follow on Twitch
              </a>
            </div>`;
        }

        meta.innerHTML = `${title}${desc}${actions}`;
        card.appendChild(img);
        card.appendChild(meta);
        grid.appendChild(card);
      });

    } catch (err) {
      console.error(err);
      showStatus('Could not load runners. Open DevTools → Console for details. Likely causes: wrong manifest path, JSON syntax error, or CORS.');
    }
  })();

  // Search init
  window.addEventListener('DOMContentLoaded', () => {
    if (window.initWikiprofiaSearch) window.initWikiprofiaSearch();
  });
</script>

</body>
</html>
